# 流光下载器 v3.0.0 故障排查指南 (TROUBLESHOOTING)

> 本文覆盖 12 类常见问题：启动、下载、字幕、音频、Cookies、SSE/UI、路径、性能、合并、构建/环境、回退、反馈信息收集。
>
> 若无法快速定位，可按“快速急救 60 秒”执行，再展开对应章节。

---
## 0. 快速急救 60 秒 Checklist
1. 关闭已运行的 `流光下载器.exe`，重新解压最新发行包（不要覆盖旧目录）。
2. 将同目录的 `cookies.txt` 暂时改名为 `cookies.off` 再试（排除坏 Cookies 干扰）。
3. 访问: `http://127.0.0.1:5000/diag/version` 是否正常返回 JSON？
4. 打开浏览器开发者工具 (F12) -> Network 是否有 `stream_task` SSE 连接 200 成功。
5. 选一个普通公开视频（非会员、非仅音频），质量选择 `best`，是否能完成？
6. 如失败，复制 `app.log` 与 `dist/流光下载器/build_meta.json` 内容备用反馈。

---
## 1. 启动类问题
| 现象 | 可能原因 | 处理步骤 |
|------|----------|----------|
| 双击无反应 / 闪退 | 缺失 `_ctypes` / 被误删 DLL | 确认发行包完整重新解压；不要放入需要管理员权限的路径 (如 `C:\Program Files`) |
| 控制台一闪即关 | 打包 Python 环境残缺 | 用官方 Release 版本；不要自行混合旧版 `ffmpeg` 或 `aria2` 目录 |
| 端口被占用 | 5000 端口已被其他程序占用 | 运行前设置环境变量 `SET FLASK_RUN_PORT=5055` 或修改启动脚本后重新启动 |
| 杀毒软件隔离文件 | EXE 首次运行被拦截 | 将解压目录加入信任/白名单后重试 |

---
## 2. 下载行为异常
| 现象 | 诊断要点 | 解决方案 |
|------|----------|----------|
| 任务卡在“探测信息” | 外网阻断 / DNS 问题 | 试移动网络 / 使用系统浏览器能否打开目标视频页；必要时开本地代理再启动 |
| 任务突然中止无错误 | SSE 被中断 | 查看浏览器 F12 Network `EventSource` 是否断开；尝试关闭浏览器加速/插件 |
| 进度始终 0% | 组件流未正确返回大小 | 观察日志 `[component-merge]` 阶段是否出现；更新到最新发行版 |
| 取消按钮无反应 | 旧标签页缓存 | 全刷新 (Ctrl+F5) 后重新发起任务 |

---
## 3. 字幕问题
| 现象 | 可能原因 | 解决 |
|------|----------|------|
| 无法下载字幕 | 该视频不提供字幕 / 区域限制 | 用浏览器手动确认字幕语言菜单是否存在；若受区域限制，可尝试 Cookies 或代理 |
| 字幕全在一行 | 这是“行合并”特性 | 正常；若需保留换行暂不支持开关，可在后续版本需求反馈 |
| 字幕乱码 | 原站返回编码异常极罕见 | 反馈 `app.log` 中 `[subtitle]` 段落 |

---
## 4. 音频相关
| 现象 | 可能原因 | 解决 |
|------|----------|------|
| 成品无声音（真实） | Fallback 音轨抓取失败 | 查看日志中是否存在 `[audio-fallback]`；尝试重新下载；若多次失败反馈日志 |
| UI 显示“无音频”但有声音 | 旧缓存前端脚本 | Ctrl+F5 强制刷新，确认版本显示 3.0.0 |
| 某些高分辨率无音频格式 | 平台只提供纯视频流 | 日志会自动尝试补抓 bestaudio，最终合并；若失败将提示 |

---
## 5. Cookies 策略
访问 `/diag/cookie_strategy` 可查看当前策略与判定。

| 场景 | 结果说明 | 操作建议 |
|------|----------|----------|
| `strategy = file` | 正在使用 `cookies.txt` | 确保文件为 Netscape 格式，UTF-8（无 BOM） |
| `strategy = browser-forced` | 环境变量强制浏览器提取 | 确认已安装支持的浏览器；若失败回退匿名请检查日志 `[COOKIES]` |
| `strategy = anonymous` | 未找到 cookies 或被禁用 | 访问会员/年龄限制资源会失败，需提供 cookies |
| 想禁用浏览器提取 | 设置 `LUMINA_DISABLE_BROWSER_COOKIES=1` | Windows 下：`set LUMINA_DISABLE_BROWSER_COOKIES=1` 再启动 |
| 强制使用浏览器提取 | 设置 `LUMINA_FORCE_BROWSER_COOKIES=1` | 与禁用变量互斥，勿同时设置 |

---
## 6. SSE / 前端 UI 异常
| 现象 | 检查 | 解决 |
|------|------|------|
| 日志区域空白 | F12 Network 中 EventSource 是否 200 | 若多次重连失败，检查本地安全软件拦截 |
| 状态条未更新 | 是否混开多个标签页 | 关闭旧标签，只保留一个页面 |
| 控制台 CORS 报错 | 反向代理/自定义部署错误 | 确保同源访问；勿用文件系统直接打开 `index.html` |

---
## 7. 下载路径 / 文件系统
| 问题 | 说明 | 解决 |
|------|------|------|
| 输出目录与预期不符 | 桌面解析 / OneDrive 重定向 | 查看 `app.log` 启动部分或 `/diag/version` 中路径字段 |
| 中文路径失败 | 理论已处理 | 若仍失败，换英文纯 ASCII 目录测试并反馈 |
| 覆盖旧文件 | 同名视频被覆盖 | 目前策略：同名可能覆盖，后续版本可加 hash/时间戳；临时手动改名 |

---
## 8. 性能 & 速度
| 现象 | 诊断 | 处理 |
|------|------|------|
| 下载速度极慢 | 站点限速 / 无 aria2 | 后续版本考虑可选连接分片；当前请更换网络或使用本地代理 |
| CPU 占用高 | ffmpeg 合并阶段 | 正常；等待合并结束即可下降 |
| 多任务并行卡顿 | 线程 + IO 竞争 | 控制同时任务数量（建议 <3） |

---
## 9. 多组件合并 / 格式
| 日志标记 | 说明 | 是否正常 |
|----------|------|----------|
| `[component-merge] scanning` | 扫描下载分片/流 | 正常 |
| `[component-merge] merging N parts` | 合并多个临时文件 | 正常 |
| `[audio-fallback] retry` | 自动补抓音频 | 若最终 success 则 OK |
| `[probe] raw formats` | yt-dlp 探测格式清单 | 诊断用途 |

---
## 10. 构建 / 环境变量
| 环境变量 | 作用 | 示例 |
|----------|------|------|
| `LUMINA_FORCE_BROWSER_COOKIES` | 强制浏览器提取 | `set LUMINA_FORCE_BROWSER_COOKIES=1` |
| `LUMINA_DISABLE_BROWSER_COOKIES` | 禁用所有 cookies | `set LUMINA_DISABLE_BROWSER_COOKIES=1` |
| `FLASK_RUN_PORT` | 自定义端口 | `set FLASK_RUN_PORT=5055` |
| （未来预留） |  |  |

---
## 11. 回退策略
| 需求 | 操作 |
|------|------|
| 快速恢复可用 | 使用上一稳定版 zip（若保留）或重新下载最新 Release 解压至全新目录 |
| 猜测构建损坏 | 对比 `build_meta.json` 与 Release 页面列出的 commit 是否一致 |
| 想完全清理 | 关闭程序 -> 删除解压目录 -> 删除同级 `app.log` -> 重新解压 |

---
## 12. 反馈所需信息清单
请尽量附上：
- 操作系统版本 (Windows 10/11 + 版本号)
- 是否代理 / VPN
- 出问题的视频 URL（可打码）
- `app.log` 相关片段（含任务开始到失败）
- `/diag/version` 与 `/diag/cookie_strategy` JSON 输出
- 如果是音频/字幕问题，附带 `[audio-fallback]` 或 `[subtitle]` 段落

---
## 13. FAQ 快速摘录
| 问题 | 简答 |
|------|------|
| 可以只下载字幕吗？ | 可以，前端勾选“字幕 only”模式 |
| 支持 8K 吗？ | 格式表达式已包含 best8k（取决于源站是否提供） |
| 为什么有些格式无音频？ | 高分辨率 DASH 分离轨，已自动补抓 bestaudio 合并 |
| Cookies 一定要用吗？ | 公开视频不需要；会员/年龄限制推荐提供 |
| 日志为什么截断？ | 防止长时间任务日志过大导致浏览器卡顿 |

---
如未覆盖你的问题，请提交 Issue 并附上“反馈所需信息清单”。欢迎提出功能建议！
